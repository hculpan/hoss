<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/hoss/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/hoss/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/hoss/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/hoss/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/hoss/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/hoss/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/hoss/',
    scheme: 'Gemini',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false,"dimmer":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="The screen device driver was the first external device I had to interface with, and much of the code that I used came from either Blundell or Fenelossa, although I certainly added my own changes and r">
<meta property="og:type" content="article">
<meta property="og:title" content="The Screen Device">
<meta property="og:url" content="http://hculpan.github.io/hoss/2019/02/24/The-Screen-Device/index.html">
<meta property="og:site_name" content="HOSS">
<meta property="og:description" content="The screen device driver was the first external device I had to interface with, and much of the code that I used came from either Blundell or Fenelossa, although I certainly added my own changes and r">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://hculpan.github.io/hoss/2019/02/24/The-Screen-Device/images/screen_output_1.png">
<meta property="og:updated_time" content="2019-03-01T15:16:03.930Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="The Screen Device">
<meta name="twitter:description" content="The screen device driver was the first external device I had to interface with, and much of the code that I used came from either Blundell or Fenelossa, although I certainly added my own changes and r">
<meta name="twitter:image" content="http://hculpan.github.io/hoss/2019/02/24/The-Screen-Device/images/screen_output_1.png">






  <link rel="canonical" href="http://hculpan.github.io/hoss/2019/02/24/The-Screen-Device/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>The Screen Device | HOSS</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/hoss/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">HOSS</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">Harry's Operating System Software</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/hoss/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/hoss/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://hculpan.github.io/hoss/hoss/2019/02/24/The-Screen-Device/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Harry Culpan">
      <meta itemprop="description" content="This is a blog about my efforts to write a 32-bit operating system">
      <meta itemprop="image" content="/hoss/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HOSS">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">The Screen Device

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-02-24 13:38:53" itemprop="dateCreated datePublished" datetime="2019-02-24T13:38:53-05:00">2019-02-24</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-03-01 10:16:03" itemprop="dateModified" datetime="2019-03-01T10:16:03-05:00">2019-03-01</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="images/screen_output_1.png" alt><br>The screen device driver was the first external device I had to interface with, and much of the code that I used came from either Blundell or Fenelossa, although I certainly added my own changes and refinements.</p>
<p>The screen device driver was instructive because, while it is simple, it is the first time that you really notice that you’re in 32-bit Protected Mode.  The reason for this is because you lose access to BIOS.  In 16-bit mode, printing out some text on the display is as simple as populating a few registers and calling the appropriate interrupt.  </p>
<p>Here, for example, is my print_string_16.asm code:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">print_string_16:			; Routine: output string in SI to screen</span><br><span class="line">	mov ah, 0Eh		        ; int 10h &apos;print char&apos; function</span><br><span class="line"></span><br><span class="line">.repeat:</span><br><span class="line">	mov al, [bx]</span><br><span class="line">	cmp al, 0</span><br><span class="line">	je .done		        ; If char is zero, end of string</span><br><span class="line">	int 10h			        ; Otherwise, print it</span><br><span class="line">    add bx, 1</span><br><span class="line">	jmp .repeat</span><br><span class="line"></span><br><span class="line">.done:</span><br><span class="line">	ret</span><br></pre></td></tr></table></figure></p>
<p>If you’re not used to Assembly code, this may be a little difficult to read, but essentially you call the routine by placing the memory address of the string you want to print into the BX register.  The routine then goes character by character, printing each one until it finds a \0 (the standard terminator for a C-style string).  At that point, it returns.  The hard work is done by the BIOS when it calls <code>int 10h</code>, which tells it to display the character in register AL to the screen.</p>
<p>But the BIOS is 16-bit code, so as soon as you switch to Protected Mode, it’s not accessible.  There are two basic solutions to this.  First, you can switch back to 16-bit mode to call the BIOS, then switch back when you’re done.  Or, second, you can interface with the device using data ports.  The latter option is the one I went with, as the former seemed more difficult.</p>
<p>When accessing the video in this manner, you can use DMA to write data to the screen.  For a VGA monitor, video memory starts at 0xb8000, so if you want to write an ‘A’ to the upper left corner, you just put an A in that memory address.  Simple.  But each screen location is actually represented by two bytes, not one.  The second byte is the attributes byte, which determines background color, foreground color, and whether it’s blinking.  So to write to the next location on the screen, you’d have to write to location 0xb8002, not 0xb8001.  This method makes a lot of things simpler than the BIOS approach, especially if you want to be able to write text at specific locations on the screen with specific colors and such.  And text wrapping is automatically handled as well.  If you’re text wraps around to the next line, this just happens because the memory is linear.  So 0xb09e is the end of the first line and 0xb0a0 is the first character of the next line.  </p>
<p>The base routine for this is <code>print_char</code> in drivers/screen.c.  This is a private routine to the device driver, so even the kernel can’t call it.  It’s just the primitive that all the other routines call.  And as with most of the rest of my code at this point, most of it comes from Blundell/Fenollosa.  It basically does of the work of taking a col/row location and converting that to a memory address, and it assigns the character and the attribute byte to the appropriate locations.  </p>
<p>The other big thing that <code>print_char</code> handles is the location of the cursor.  When a character is printed, <code>print_char</code> will automatically set the cursor to the next location on the screen.  It does this by using the data ports for the VGA display device.  In <code>cpu/ports.c</code> are a set of generic routines to read/write bytes and shorts to device ports.  To change the location of the cursor, it sets the offset (the calculated offset from 0xb8000 based on the column and row) to the device, with the high byte being written to port 0x3d4 and the low byte to 0x3d5.  To find the location of the cursor, it just reads the bytes from thexe same ports.  This feature comes in handy, because then we can provide routines that don’t require a location.  You can print a message to the screen, and the cursor will move to the end of that message.  Then when you print another message, assuming you don’t provide a specific location, it just uses the cursor location to figure out where to put the new message.</p>
<p>One weakness of writing to video memory, however, is scrolling.  When text hits the bottom of the screen, we expect that the text just scrolls upward.  Using DMA, there’s no easy way to do this.  I wrote a function, handle_scrolling, that simply moves everything in video memory as if it were one line higher, then outputs the new bottom line.</p>
<p>The only other issue was the backspace.  Fenollosa had a routine, <code>kprint_backspace()</code>, that I largely used as is, but it didn’t seem to quite work for me.  When I tested it, hitting the backspace created an inverse dot character; it didn’t actually backspace.  I fixed that so it blanked out whatever character was then and moved the cursor back one full space.</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/hoss/2019/02/23/Structure-of-HOSS/" rel="next" title="Structure of HOSS">
                <i class="fa fa-chevron-left"></i> Structure of HOSS
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/hoss/2019/02/27/Interfacing-with-the-Keyboard/" rel="prev" title="Interfacing with the Keyboard">
                Interfacing with the Keyboard <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Harry Culpan</p>
              <p class="site-description motion-element" itemprop="description">This is a blog about my efforts to write a 32-bit operating system</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/hoss/archives/">
                
                    <span class="site-state-item-count">9</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/hculpan" title="GitHub &rarr; https://github.com/hculpan" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:harry@culpan.org" title="E-Mail &rarr; mailto:harry@culpan.org" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Harry Culpan</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.0.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/hoss/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/hoss/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/hoss/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/hoss/js/src/utils.js?v=7.0.1"></script>

  <script src="/hoss/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/hoss/js/src/affix.js?v=7.0.1"></script>

  <script src="/hoss/js/src/schemes/pisces.js?v=7.0.1"></script>




  
  <script src="/hoss/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/hoss/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/hoss/js/src/bootstrap.js?v=7.0.1"></script>


  
  


  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
