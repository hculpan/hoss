<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/hoss/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/hoss/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/hoss/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/hoss/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/hoss/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/hoss/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/hoss/',
    scheme: 'Gemini',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false,"dimmer":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Over the last two days, I’ve been contemplating my next steps with the OS, with the two most obvious choices being memory manager or floppy drive interface.  But pretty quickly I settled on the memory">
<meta property="og:type" content="article">
<meta property="og:title" content="How Much Memory Do I Have?">
<meta property="og:url" content="http://hculpan.github.io/hoss/2019/03/01/How-Much-Memory-Do-I-Have/index.html">
<meta property="og:site_name" content="HOSS">
<meta property="og:description" content="Over the last two days, I’ve been contemplating my next steps with the OS, with the two most obvious choices being memory manager or floppy drive interface.  But pretty quickly I settled on the memory">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://hculpan.github.io/hoss/2019/03/01/How-Much-Memory-Do-I-Have/images/mem_map.png">
<meta property="og:updated_time" content="2019-03-03T18:19:35.338Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="How Much Memory Do I Have?">
<meta name="twitter:description" content="Over the last two days, I’ve been contemplating my next steps with the OS, with the two most obvious choices being memory manager or floppy drive interface.  But pretty quickly I settled on the memory">
<meta name="twitter:image" content="http://hculpan.github.io/hoss/2019/03/01/How-Much-Memory-Do-I-Have/images/mem_map.png">






  <link rel="canonical" href="http://hculpan.github.io/hoss/2019/03/01/How-Much-Memory-Do-I-Have/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>How Much Memory Do I Have? | HOSS</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/hoss/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">HOSS</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">Harry's Operating System Software</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/hoss/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/hoss/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://hculpan.github.io/hoss/hoss/2019/03/01/How-Much-Memory-Do-I-Have/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Harry Culpan">
      <meta itemprop="description" content="This is a blog about my efforts to write a 32-bit operating system">
      <meta itemprop="image" content="/hoss/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HOSS">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">How Much Memory Do I Have?

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-03-01 10:20:20" itemprop="dateCreated datePublished" datetime="2019-03-01T10:20:20-05:00">2019-03-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-03-03 13:19:35" itemprop="dateModified" datetime="2019-03-03T13:19:35-05:00">2019-03-03</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Over the last two days, I’ve been contemplating my next steps with the OS, with the two most obvious choices being memory manager or floppy drive interface.  But pretty quickly I settled on the memory manager as the more fundamental component.  As the OS is now, I have full control over memory even in my “user” shell program (I haven’t implemented any sort of protection yet), and with a 32-bit memory model, I clearly have enough space to load a whole floppy into memory many times over.  But I feel like I wouldn’t get too far before I’d want to have some way to allocate and track memory.</p>
<p>With that in mind, I’ve been looking at various sources for an approach to memory management, but the best I’ve found is Tannenbaum’s book, “Modern Operating Systemns”.  Based on that, I’ve decided to go with a page allocator using the buddy algorithm.  This is just for physical memory, of course; I have no plans to implement virtual memory, as I can’t imagine this project getting big enough that I’d ever need it.  When I launch QEMU to test HOSS, I’m already allocating 1gb.  This is way less than my computer actually has, of course, so I’ve got plenty of room to grow.  But at the moment, 1gb seems like more memory than I could possibly use.  So just physical ram it is!</p>
<p>The first step in constructing a memory manager, though, is to figure out how much ram I actually have.  My first attempt at googling brought me to a page discussing BIOS interrupt 15h, function E801h.  The nice thing is, this is quite simple and only took me a minute or two to add to my <code>boot/boot_sect.asm</code> file.  The only wrinkle I found here was that, since it’s a BIOS call, I had to call it from my 16-bit boot loader, but how to get it to my 32-bit kernel?  I solved that just by adding a variable to my boot loader.  Since I wanted to be sure I knew what address it would be at, since I would have to hard code the address in my 32-bit kernel, I put it at the top of the boot loader, not the bottom.  Thus the top of <code>boot/boot_sect.asm</code> became:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[org 0x7c00]</span><br><span class="line">KERNEL_OFFSET equ 0x1000</span><br><span class="line"></span><br><span class="line">[bits 16]</span><br><span class="line">    jmp boot_start</span><br><span class="line"></span><br><span class="line">MEMORY_SIZE     dd 0x00000000</span><br><span class="line">BOOT_DRIVE      db  0</span><br><span class="line"></span><br><span class="line">boot_start:</span><br></pre></td></tr></table></figure></p>
<p>By doing this, I knew that MEMORY_SIZE would be at 7C02h, because <code>jmp boot_start</code> when assembled would take up only 2 bytes.  This added the tiny overhead of a small jump, but since I will likely use FAT12/16 as my file system, I will need to put a structure at the top of the boot loader in any case.</p>
<p>With that done, I simply created an <code>int *</code> in my kernel and hard coded the address to 7C02h, and viola I had the amount of available ram.</p>
<p>But there’s a wrinkle to this simple solution.  While it tells me how much ram is free, it doesn’t tell me where it is.  At first I was going to hard code this, but then I found the <a href="https://wiki.osdev.org/Main_Page" target="_blank" rel="noopener">OS Dev Wiki</a> and it’s explanation for <a href="https://wiki.osdev.org/Detecting_Memory_(x86" target="_blank" rel="noopener">detecting memory</a>).  It discussed function E801h, of course, but indicated that E820h is really the standard function for finding available information.  Rather than giving you a since amount of available memory, it gaves you a table of memory ranges, indicating which are usable and which are not.</p>
<p>E820h definitely took some time to understand, and even though they had two sample implementations (one in assembly, the other C), it took me a while to figure out the particulars.  But though the E820h call has a number of peculariaties, overall it’s pretty straightforward.  You call the function repeatedly with each call giving you the next entry in the table.  Each entry gives you the starting address of the memory block, the length, and the type (1 = usable, anything else meaning not).  Using the example assembler code, I had an integer value (4 bytes) at 8000h, which was the number of entries.  The table was put right after this, with each entry being a total of 24 bytes in length.  Thus the first entry was at 8004h, the second at 801Ch, and so on.  So it was a simple matter in the kernel to hard code another <code>int *</code> to 8000h.  I then created a struct to match the layout of the table entries, created a pointer to the struct hard coded to 8004h, and then just treated the table as an array.  Very simple.</p>
<p>But it didn’t quite work out.  I kept getting very odd values.  For example, my first memory block was a usable segment at address 0, but it was only 2 bytes long.  And the vast bulk of memory was in an unusable block, also starting at 0.  The documentation warned that there could be overlap, but this was ridiculous.  I did some further searching and found that others had had similar problems, and the resolution had been to pack the struct.  Basically the concern was that the optimizer was trying to align the 64-bit entries along 8-byte boundaries.  I tried adding <code>__attribute((packed))__</code>, but this didn’t change anything.  I also tried breaking the 64-bit numbers into two 32-bit numbers, especially since the numbers I was dealing with would all fit easily in the lower portion.  But while that changed the numbers, they still were pretty screwed up.</p>
<p>My final solution was a bit of a kludge, but it worked.  Rather than using a struct, I just used pointer arithmetic.  So I set my base pointer address to 8004h.  As I looked through the entries, I just changed the base pointer to <code>8004h + (index * 24)</code>.  And then I’d add the offset for the specific value location.  For example, the length is the second 64-bit value in the entry, so it’s address was <code>8004h + 8 + (index * 24)</code>.  Once I did that, everything worked.</p>
<p><img src="images/mem_map.png" alt></p>
<p>My final bit of work on this was to add support to the shell for the commands <code>memmap</code> and <code>memmap full</code>, which showed the map of usable memory and of all memory, respectively.</p>
<p>At the end of all this, as I was doing final testing, I came across a bit of a vexing problem.  I had added a block in the kernel to display available memory as it started up.  I outputted this in decimal rather than hex, and I wanted it separated with commas, as it’s easier to read.  This necessitated adding several new functions and code blocks.  None of it a big deal, except suddenly my shell stopped functioning correctly.  It stopped outputting the prompt <code>&gt;</code> and the intro text, but you could still type and it would output what you typed.  I backed out all of my code, of course, and the problem went away.  But after scanning the code and seeing no issue, I put it back but removed the code that called it.  So it would be a part of my OS image, but not actually called.  My problem came back.  I concocted theories of memory being overwritten and that sort of thing, all of which turned out to lead nowhere.  What it turned out to be is that my boot loader would load up 15 sectors off the boot disk, but my os-image had grown to 25 sectors.  So it wasn’t loaded a big chunk of it into memory.  Obviously the fix was simple, just load more sectors into memory.  Since it doesn’t give an error if those sectors don’t exist (i.e., if the os-image file is only 10k in size, ~20 sectors, but you say load 30, it will just load what it can find and give no error), I set it to load 50 sectors.  Honestly, I probably should have gone higher, but c’est la vie.  </p>
<p>If my kernel grows much larger, I’ll probably start looking into doing a multi-stage loader (i.e., load boot sector first, which loads pre-kernel, which then loads final runtime kernel).  By the time I get to this point, though, I presumably will have a file system that I can read for my final kernel.</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/hoss/2019/02/28/A-Command-Shell/" rel="next" title="A Command Shell">
                <i class="fa fa-chevron-left"></i> A Command Shell
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/hoss/2019/03/10/Managine-Memory/" rel="prev" title="Managing Memory and Bochs">
                Managing Memory and Bochs <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Harry Culpan</p>
              <p class="site-description motion-element" itemprop="description">This is a blog about my efforts to write a 32-bit operating system</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/hoss/archives/">
                
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/hculpan" title="GitHub &rarr; https://github.com/hculpan" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:harry@culpan.org" title="E-Mail &rarr; mailto:harry@culpan.org" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Harry Culpan</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.0.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/hoss/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/hoss/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/hoss/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/hoss/js/src/utils.js?v=7.0.1"></script>

  <script src="/hoss/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/hoss/js/src/affix.js?v=7.0.1"></script>

  <script src="/hoss/js/src/schemes/pisces.js?v=7.0.1"></script>




  
  <script src="/hoss/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/hoss/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/hoss/js/src/bootstrap.js?v=7.0.1"></script>


  
  


  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
